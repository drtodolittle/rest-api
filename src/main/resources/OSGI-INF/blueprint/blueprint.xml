<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

 <!-- to setup camel servlet with OSGi HttpService -->
  <reference id="httpService" interface="org.osgi.service.http.HttpService"/>

  <bean class="org.apache.camel.component.servlet.osgi.OsgiServletRegisterer" destroy-method="unregister" init-method="register">
    <property name="alias" value="/api"/>
    <property name="httpService" ref="httpService"/>
    <property name="servlet" ref="camelServlet"/>
  </bean>
  
  <bean class="org.apache.camel.component.servlet.CamelHttpTransportServlet" id="camelServlet"/>
  <bean class="de.drtodolittle.processor.ExtractProcessInstanceIds" id="extractProcessIdsProcessor" />
  <bean class="de.drtodolittle.processor.GenerateToDoJSON" id="generateToDoJSONProcessor" />
  <bean class="de.drtodolittle.processor.GenerateCreateProcessJSON" id="generateCreateProcessJSONProcessor" />
  <bean class="de.drtodolittle.aggregate.ProcessInstanceVariables" id="processInstanceVariablesAggregationStrategy" />
  
 
    <camelContext xmlns="http://camel.apache.org/schema/blueprint">
		<restConfiguration bindingMode="off" component="servlet" contextPath="/api" enableCORS="true"/>	  

		<rest path="/ping">
			<get uri="/" >
				<to uri="direct:ping" />
			</get>
		</rest>

		<rest path="/todos">
			<get uri="/" produces="application/json">
				<to uri="direct:gettodos" />
			</get>
			<post uri="/" produces="application/json">
				<to uri="direct:createtodo" />
			</post>
			<get uri="/{id}" produces="application/json">
				<to uri="direct:gettodo" />
			</get>
			<delete uri="/{id}">
				<to uri="direct:deletetodo" />
			</delete>
			<put uri="/{id}" produces="application/json">
				<to uri="direct:updatetodo" />
			</put>
			<get uri="/{id}/done" produces="application/json">
				<to uri="direct:noanswer" />
			</get>
		</rest>

	  <route>
		<from uri="direct:ping" />
		<transform>
			<constant>Hello, I'm Dr ToDo Little!</constant>
		</transform>
	  </route>
	  
	  <route>
		<from uri="direct:gettodo" />
		<to uri="velocity:templates/gettask.vm" />
	  </route>
	  
	  <route>
		<from uri="direct:updatetodo" />
		<to uri="velocity:templates/updatetask.vm" />
	  </route>

	  <route>
		<from uri="direct:gettodos" />
                <setHeader headerName="Exchange.HTTP_URI"><constant>http://localhost:10080/engine-rest</constant></setHeader>
                <setHeader headerName="Exchange.HTTP_PATH"><constant>/process-instance</constant></setHeader>
                <setHeader headerName="Exchange.HTTP_QUERY"><constant>businessKey=dirk</constant></setHeader>
		<to uri="http4://localhost:10080/engine-rest/process-instance?businessKey=dirk" />
                <process ref="extractProcessIdsProcessor" />
                <split strategyRef="processInstanceVariablesAggregationStrategy">
                    <simple>${header.processIds}</simple>
                    <to uri="direct:gettodovariables" />
                </split>
                <setBody><simple>[${body}]</simple></setBody>
	  </route>

          <route>
		<from uri="direct:gettodovariables" />
                <setHeader headerName="Exchange.HTTP_PATH"><constant>/variable-instance</constant></setHeader>
                <setHeader headerName="Exchange.HTTP_QUERY">
                    <groovy>
                        processInstanceIdIn=request.headers.processIds[exchange.properties.CamelSplitIndex]
                        return "processInstanceIdIn=$processInstanceIdIn"
                    </groovy>
                </setHeader>
		<to uri="http4://localhost:10080/engine-rest/process-instance?businessKey=dirk" />
                <process ref="generateToDoJSONProcessor" />
	  </route>
	  
	  <route>
		<from uri="direct:noanswer" />
		<setHeader headerName="Exchange.HTTP_RESPONSE_CODE"><constant>204</constant></setHeader>
	  </route>

          <route>
		<from uri="direct:deletetodo" />
                <setHeader headerName="Exchange.HTTP_URI"><constant>http://localhost:10080/engine-rest</constant></setHeader>
                <setHeader headerName="Exchange.HTTP_PATH">
                    <groovy>
                        def origPath = request.getHeader(exchange.HTTP_PATH)
                        def id = origPath.substring(origPath.lastIndexOf("/"))
                        return "/process-instance" + id
                    </groovy>
                </setHeader>
                <setHeader headerName="CamelHttpMethod"><constant>DELETE</constant></setHeader>
		<to uri="http4://localhost:10080/engine-rest/" />
		<setHeader headerName="Exchange.HTTP_RESPONSE_CODE"><constant>204</constant></setHeader>
	  </route>
	  
	  <route>
		<from uri="direct:createtodo" />
                <process ref="generateCreateProcessJSONProcessor" />
                <to uri="log:createtask?showStreams=true&amp;showHeaders=true" />
                <setHeader headerName="Exchange.HTTP_URI"><constant>http://localhost:10080/engine-rest</constant></setHeader>
                <setHeader headerName="Exchange.HTTP_PATH"><constant>/process-definition/key/DrToDoLittle/start</constant></setHeader>
                <setHeader headerName="CamelHttpMethod"><constant>POST</constant></setHeader>
                <setHeader headerName="Exchange.CONTENT_TYPE"><constant>application/json</constant></setHeader>
		<to uri="http4://localhost:10080/engine-rest/process-instance?businessKey=dirk" />
                
	  </route>
    </camelContext>

</blueprint>
