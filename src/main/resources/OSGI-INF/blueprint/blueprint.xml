<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

 <!-- to setup camel servlet with OSGi HttpService -->
  <reference id="httpService" interface="org.osgi.service.http.HttpService"/>

  <bean class="org.apache.camel.component.servlet.osgi.OsgiServletRegisterer" destroy-method="unregister" init-method="register">
    <property name="alias" value="/api"/>
    <property name="httpService" ref="httpService"/>
    <property name="servlet" ref="camelServlet"/>
  </bean>
  
  <bean class="org.apache.camel.component.servlet.CamelHttpTransportServlet" id="camelServlet"/>

 
    <camelContext xmlns="http://camel.apache.org/schema/blueprint">
		<restConfiguration bindingMode="off" component="servlet" contextPath="/api" enableCORS="true"/>	  

		<rest path="/ping">
			<get uri="/" >
				<to uri="direct:ping" />
			</get>
		</rest>

		<rest path="/todos">
			<get uri="/" produces="application/json">
				<to uri="direct:gettasks" />
			</get>
			<post uri="/" produces="application/json">
				<to uri="direct:createtask" />
			</post>
			<get uri="/{id}" produces="application/json">
				<to uri="direct:gettask" />
			</get>
			<delete uri="/{id}">
				<to uri="direct:noanswer" />
			</delete>
			<put uri="/{id}" produces="application/json">
				<to uri="direct:updatetask" />
			</put>
			<get uri="/{id}/done" produces="application/json">
				<to uri="direct:noanswer" />
			</get>
		</rest>

	  <route>
		<from uri="direct:ping" />
		<transform>
			<constant>Hello, I'm Dr ToDo Little!</constant>
		</transform>
	  </route>
	  
	  <route>
		<from uri="direct:gettask" />
		<to uri="velocity:templates/gettask.vm" />
	  </route>
	  
	  <route>
		<from uri="direct:updatetask" />
		<to uri="velocity:templates/updatetask.vm" />
	  </route>

	  <route>
		<from uri="direct:gettasks" />
		<to uri="http4://localhost:10080/engine-rest/process-instance?businessKey=dirk" />
                <setHeader headerName="processInstanceIds">
                    <groovy><![CDATA[ 
                        import groovy.json.JsonSlurper

                        //def input = request.getBody()
                        def input = new File("../../../../sampledata/getProcessInstances.json").getText()
                        def jsonSlurper = new JsonSlurper()
                        def tasks = jsonSlurper.parseText(input)
                        def processIds = []

                        tasks.each({ 
                                processIds.add(it.id)
                        println it.id })

                        processIds
                        
                    ]]>
                    </groovy>
		<to uri="velocity:templates/gettasks.vm" />
	  </route>
	  
	  <route>
		<from uri="direct:noanswer" />
		<setHeader headerName="Exchange.HTTP_RESPONSE_CODE"><constant>204</constant></setHeader>
	  </route>
	  
	  <route>
		<from uri="direct:createtask" />
		<to uri="velocity:templates/createtask.vm" />
	  </route>
    </camelContext>

</blueprint>
